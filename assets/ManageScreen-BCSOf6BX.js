import{r as o,j as e,_ as q}from"./index-Cuv1hYfA.js";import"./firebaseAuth-DlN8ja1T.js";import"./firebaseStore-DfVX9XbF.js";function ue(a){const s=a.items.map(N=>N.trim().toLowerCase()).filter(Boolean),h=[String(a.subject).trim().toLowerCase(),String(a.mode).trim().toLowerCase(),String(a.level).trim().toLowerCase(),String(a.owner).trim().toLowerCase(),String(a.note||"").trim().toLowerCase(),s.join("|")].join("::");return`csv_${encodeURIComponent(h).replace(/%/g,"").slice(0,80)}`}function me(a){return a.map((s,h)=>{const f=Object.keys(s).filter(j=>/^item\d+$/i.test(j)).sort((j,l)=>{const x=Number(j.replace(/[^0-9]/g,""))||0,O=Number(l.replace(/[^0-9]/g,""))||0;return x-O}).map(j=>String(s[j]||"").trim()).filter(Boolean),N=f.join(", "),y=s.subject||"english",C=s.mode||(y==="math"?"calc":"recall"),d={subject:y,mode:C,level:s.level||"chunk",owner:s.owner||"shared",importance:Number(s.importance??1),note:String(s.note||"").trim()||N,answer:String(s.answer||"").trim(),answer1:String(s.answer1||"").trim(),items:f};return{...d,id:String(s.id||"").trim()||ue(d)||`csv_row_${h}`}}).filter(s=>s.items.length>=1)}function he(a,s){return String(a||"").toLowerCase().includes(s.toLowerCase())}function xe({wordSets:a,userId:s,profile:h,onAdd:f,onUpdate:N,onDelete:y,onBulkAdd:C,onDataChanged:d,onDataUploaded:j}){const l=(h==null?void 0:h.role)==="parent",[x,O]=o.useState("english"),[R,G]=o.useState("chunk"),[F,H]=o.useState((h==null?void 0:h.role)==="parent"?"shared":"child"),[X,J]=o.useState(2),[T,P]=o.useState(""),[V,c]=o.useState(""),[k,S]=o.useState([]),[_,K]=o.useState("all"),[w,Q]=o.useState("all"),[$,Y]=o.useState("all"),[L,Z]=o.useState("all"),[E,U]=o.useState(""),I=T.split(`
`).map(t=>t.trim()).filter(Boolean),z=I.join(", "),D=k.length,ee=o.useMemo(()=>new Set(k),[k]),te=o.useMemo(()=>{const t=Array.from(new Set(a.map(n=>n.level).filter(Boolean)));return t.sort(),t},[a]),v=o.useMemo(()=>{const t=E.trim().toLowerCase();return a.filter(n=>{if(_!=="all"&&(n.subject||"english")!==_||w!=="all"&&n.level!==w||$!=="all"&&(n.owner||"shared")!==$||L!=="all"&&Number(n.importance??0)!==Number(L))return!1;if(!t)return!0;const i=[n.id,n.note,n.level,n.owner,n.subject,...n.items||[]].join(" ");return he(i,t)})},[a,_,w,$,L,E]);o.useEffect(()=>{S(t=>t.filter(n=>v.some(i=>i.id===n)))},[v]);const ne=async()=>{if(!l){c("childアカウントではデータ編集できません");return}if(I.length<1){c("1行以上入力してください");return}await f({subject:x,mode:x==="math"?"calc":"recall",level:R,owner:F,importance:X,note:z,items:I},s),P(""),c("セットを追加しました"),d==null||d()},se=async t=>{var W;if(!l){c("childアカウントではデータ編集できません");return}const n=(W=t.target.files)==null?void 0:W[0];if(!n)return;const i=await q(()=>import("./xlsx-D_0l8YDs.js"),[]),r=await n.arrayBuffer(),p=i.read(r,{type:"array"}),u=p.Sheets[p.SheetNames[0]],m=i.utils.sheet_to_json(u,{defval:""}),b=me(m),g=await C(b,s);c(g?`${g.total}件処理（新規 ${g.created} / 更新 ${g.updated}）`:`${b.length}件インポートしました`),j==null||j()},le=t=>{S(n=>n.includes(t)?n.filter(i=>i!==t):[...n,t])},ie=()=>{S(v.map(t=>t.id))},ae=()=>{S([])},ce=t=>t.map(n=>{var i,r,p,u,m,b;return{id:n.id||"",subject:n.subject||"english",mode:n.mode||((n.subject||"english")==="math"?"calc":"recall"),level:n.level||"",owner:n.owner||"shared",importance:Number(n.importance??1),note:n.note||(Array.isArray(n.items)?n.items.join(", "):""),item1:((i=n.items)==null?void 0:i[0])||"",item2:((r=n.items)==null?void 0:r[1])||"",item3:((p=n.items)==null?void 0:p[2])||"",item4:((u=n.items)==null?void 0:u[3])||"",item5:((m=n.items)==null?void 0:m[4])||"",item6:((b=n.items)==null?void 0:b[5])||"",answer:n.answer||"",answer1:n.answer1||""}}),B=async(t,n)=>{const i=a.filter(g=>(g.subject||"english")===t);if(i.length===0){c(`${t}: エクスポート対象データがありません`);return}const r=await q(()=>import("./xlsx-D_0l8YDs.js"),[]),p=["id","subject","mode","level","owner","importance","note","item1","item2","item3","item4","item5","item6","answer","answer1"],u=ce(i),m=r.utils.json_to_sheet(u,{header:p}),b=r.utils.book_new();r.utils.book_append_sheet(b,m,"Sheet1"),r.writeFile(b,n,{bookType:"biff8"}),c(`${n} をエクスポートしました（${u.length}件）`)},re=async()=>{if(!l){c("childアカウントではエクスポートできません");return}await B("english","english.xls"),await B("japanese","japanese.xls"),await B("math","math.xls")},M=async(t,n)=>{if(!l){c("childアカウントではデータ編集できません");return}if(t.length===0){c("削除対象を選択してください");return}if(!window.confirm(`${t.length}件を削除します。よろしいですか？`))return;let i=0,r=0;const p=new Map(a.map(u=>[u.id,u]));for(const u of t){const m=p.get(u);if(m)try{await y(m,s),i+=1}catch{r+=1}}S(u=>u.filter(m=>!t.includes(m))),c(`${n}: ${i}件削除${r>0?` / ${r}件失敗`:""}`),i>0&&(d==null||d())},A=async(t,n)=>{const i=a.filter(r=>(r.subject||"english")===t).map(r=>r.id);await M(i,`${n}一括削除`)},oe=async(t,n)=>{if(!l){c("childアカウントではデータ編集できません");return}if(Number(t.importance)!==n)try{await N({...t,importance:n},s),c(`importanceを更新: ${t.id} -> ${n}`),d==null||d()}catch{c("importance更新に失敗しました")}},de=async t=>{if(!l){c("childアカウントではデータ編集できません");return}try{await y(t,s),c("削除しました"),d==null||d()}catch{c("削除に失敗しました")}};return e.jsxs("div",{className:"card",children:[e.jsx("h2",{children:"データ管理"}),!l&&e.jsx("div",{className:"offline-banner",children:"childアカウントでは管理編集できません（閲覧のみ）。"}),e.jsxs("div",{className:"grid2",children:[e.jsxs("select",{value:x,onChange:t=>O(t.target.value),children:[e.jsx("option",{value:"english",children:"english"}),e.jsx("option",{value:"japanese",children:"japanese"}),e.jsx("option",{value:"math",children:"math"})]}),e.jsxs("select",{value:R,onChange:t=>G(t.target.value),children:[e.jsx("option",{value:"chunk",children:"chunk"}),e.jsx("option",{value:"collocation",children:"collocation"}),e.jsx("option",{value:"sentence",children:"sentence"}),e.jsx("option",{value:"熟語",children:"熟語"}),e.jsx("option",{value:"単語",children:"単語"}),e.jsx("option",{value:"文",children:"文"}),e.jsx("option",{value:"basic",children:"basic"}),e.jsx("option",{value:"+",children:"+"}),e.jsx("option",{value:"x",children:"x"})]})]}),e.jsxs("div",{className:"grid2",children:[e.jsxs("select",{value:F,onChange:t=>H(t.target.value),children:[e.jsx("option",{value:"child",children:"child"}),e.jsx("option",{value:"parent",children:"parent"}),e.jsx("option",{value:"shared",children:"shared"})]}),e.jsx("input",{value:x==="math"?"calc":"recall",readOnly:!0})]}),e.jsxs("div",{className:"grid2",children:[e.jsx("div",{className:"row",children:[0,1,2,3].map(t=>e.jsx("button",{type:"button",className:`chip ${X===t?"active":""}`,onClick:()=>J(t),children:"★".repeat(t)||"☆"},t))}),e.jsx("input",{value:z,readOnly:!0,placeholder:"note (自動生成)"})]}),e.jsx("textarea",{rows:6,value:T,onChange:t=>P(t.target.value),placeholder:`item1
item2
item3
item4
item5
item6`,disabled:!l}),e.jsx("button",{className:"btn btn-primary",onClick:ne,disabled:!l,children:"セット追加"}),e.jsxs("div",{className:"section",children:[e.jsx("label",{children:"CSV/XLSXインポート"}),e.jsx("input",{type:"file",accept:".csv,.xlsx,.xls",onChange:se,disabled:!l})]}),e.jsxs("div",{className:"section",children:[e.jsx("label",{children:"エクスポート（ダウンロード）"}),e.jsx("div",{className:"row",children:e.jsx("button",{className:"btn btn-primary",type:"button",onClick:re,disabled:!l,children:"3科目まとめて"})}),e.jsx("div",{className:"muted",children:"ダウンロード後、PCの`data`フォルダにあるExcelファイルを置き換えてください。"})]}),V&&e.jsx("div",{className:"muted",children:V}),e.jsxs("div",{className:"section",children:[e.jsxs("div",{className:"row between",children:[e.jsxs("h3",{children:["セット一覧 (",v.length," / ",a.length,")"]}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"btn btn-ghost",type:"button",onClick:()=>A("english","英語"),disabled:!l,children:"英語一括削除"}),e.jsx("button",{className:"btn btn-ghost",type:"button",onClick:()=>A("japanese","国語"),disabled:!l,children:"国語一括削除"}),e.jsx("button",{className:"btn btn-ghost",type:"button",onClick:()=>A("math","算数"),disabled:!l,children:"算数一括削除"})]})]}),e.jsxs("div",{className:"manage-filters",children:[e.jsxs("select",{value:_,onChange:t=>K(t.target.value),children:[e.jsx("option",{value:"all",children:"subject: all"}),e.jsx("option",{value:"english",children:"english"}),e.jsx("option",{value:"japanese",children:"japanese"}),e.jsx("option",{value:"math",children:"math"})]}),e.jsxs("select",{value:w,onChange:t=>Q(t.target.value),children:[e.jsx("option",{value:"all",children:"level: all"}),te.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsxs("select",{value:$,onChange:t=>Y(t.target.value),children:[e.jsx("option",{value:"all",children:"owner: all"}),e.jsx("option",{value:"shared",children:"shared"}),e.jsx("option",{value:"parent",children:"parent"}),e.jsx("option",{value:"child",children:"child"})]}),e.jsxs("select",{value:L,onChange:t=>Z(t.target.value),children:[e.jsx("option",{value:"all",children:"importance: all"}),e.jsx("option",{value:"3",children:"★★★"}),e.jsx("option",{value:"2",children:"★★"}),e.jsx("option",{value:"1",children:"★"}),e.jsx("option",{value:"0",children:"☆"})]}),e.jsx("input",{value:E,onChange:t=>U(t.target.value),placeholder:"キーワード検索（id / note / item）"})]}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"btn btn-ghost",type:"button",onClick:ie,disabled:!l,children:"全選択"}),e.jsx("button",{className:"btn btn-ghost",type:"button",onClick:ae,disabled:!l,children:"選択解除"}),e.jsxs("button",{className:"btn btn-ghost",type:"button",onClick:()=>M(k,"選択削除"),disabled:!l,children:["選択削除 (",D,")"]}),e.jsx("button",{className:"btn btn-ghost",type:"button",onClick:()=>M(v.map(t=>t.id),"一覧削除"),disabled:!l,children:"一覧削除"})]}),e.jsx("div",{className:"stack",children:v.map(t=>e.jsxs("div",{className:"list-item manage-list-item",children:[e.jsx("input",{type:"checkbox",className:"manage-checkbox",checked:ee.has(t.id),onChange:()=>le(t.id),disabled:!l}),e.jsxs("div",{className:"manage-list-text",children:[e.jsxs("div",{children:[t.subject||"english"," | ",t.mode||"recall"," | ",t.level," | ","★".repeat(t.importance||0)||"☆"," | ",t.owner]}),e.jsx("div",{className:"muted",children:t.note||t.items.join(", ")}),e.jsx("div",{className:"row",children:[0,1,2,3].map(n=>e.jsx("button",{type:"button",className:`chip ${Number(t.importance||0)===n?"active":""}`,onClick:()=>oe(t,n),disabled:!l,children:"★".repeat(n)||"☆"},n))})]}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>de(t),disabled:!l,children:"削除"})]},t.id))})]})]})}export{xe as default};
