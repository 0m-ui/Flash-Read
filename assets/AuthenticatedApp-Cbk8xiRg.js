const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/SessionScreen-DaOYjHzj.js","assets/index-Cuv1hYfA.js","assets/firebaseAuth-DlN8ja1T.js","assets/firebaseStore-DfVX9XbF.js","assets/index-CV6xmNsk.css","assets/SessionScreen-D4wfILL1.css","assets/ManageScreen-BCSOf6BX.js","assets/StatsScreen-BbkiHsHC.js"])))=>i.map(i=>d[i]);
import{r as c,d as v,j as a,_ as Y}from"./index-Cuv1hYfA.js";import{c as G,o as K,q as X,a as Z,s as q,d as D,b as ne,w as ae,e as H,r as oe}from"./firebaseStore-DfVX9XbF.js";const J=[{id:"sample_chunk_1",subject:"english",mode:"recall",level:"chunk",owner:"shared",importance:3,note:"-ight family",items:["light","night","right","fight","bright"]},{id:"sample_collocation_1",subject:"english",mode:"recall",level:"collocation",owner:"shared",importance:3,note:"ÂéüÂõ†„ÉªÁêÜÁî±",items:["because of","due to","as a result","therefore","owing to"]},{id:"sample_sentence_1",subject:"english",mode:"recall",level:"sentence",owner:"shared",importance:2,note:"Áü≠ÊñáË™≠Ëß£",items:["She reads every night.","He wrote a letter yesterday.","They play outside after school.","We made progress this week.","I look forward to seeing you."]}],P={totalSessions:0,totalCorrect:0,totalItems:0},re="english";function ce(e){return e==="math"?"calc":"recall"}function F(e){const t=(e==null?void 0:e.subject)||re;return{...e,subject:t,mode:(e==null?void 0:e.mode)||ce(t)}}function R(e){return Array.isArray(e)?e.map(t=>F(t)):[]}function y(e,t){try{const s=localStorage.getItem(e);return s?JSON.parse(s):t}catch{return t}}function M(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch{}}const T=e=>`es_wordSets_${e||"guest"}`,E=e=>`es_records_${e||"guest"}`,W=e=>`export_alert_needed_${e||"guest"}`;function le(e,t){const[s,o]=c.useState(()=>R(y(T(e),J))),[x,_]=c.useState(!1),[h,b]=c.useState(!1);c.useEffect(()=>{if(!e){o(R(y(T(e),J))),b(!0);return}_(!0),b(!1);const r=G(v,"wordSets","shared","sets"),m=G(v,"wordSets",e,"sets");let i=[],f=[];const u=()=>{const w=[...i,...f];if(w.length===0){const j=R(J);o(j),M(T(e),j)}else{const j=R(w);o(j),M(T(e),j)}},g=K(X(r,Z("createdAt","asc")),w=>{i=w.docs.map(j=>F({id:j.id,...j.data(),owner:"shared"})),u(),_(!1)},()=>{b(!0),_(!1),o(R(y(T(e),J)))}),S=K(X(m,Z("createdAt","asc")),w=>{f=w.docs.map(j=>F({id:j.id,...j.data()})),u()},()=>{b(!0),o(R(y(T(e),J)))});return()=>{g(),S()}},[e]);const d=c.useCallback(async(r,m)=>{const i=r.owner||"shared";if(i==="shared"&&t!=="parent")throw new Error("Only parent can write shared sets.");const f=`ws_${Date.now()}_${Math.random().toString(36).slice(2,7)}`,u=F({...r,id:f,createdAt:Date.now()});return!m||h?(o(S=>{const w=[...S,u];return M(T(m),w),w}),f):(await q(D(v,...i==="shared"?["wordSets","shared","sets",f]:["wordSets",m,"sets",f]),{...F(r),id:f,createdAt:H()}),f)},[h,t]),l=c.useCallback(async(r,m)=>{const i=r.owner||"shared";if(i==="shared"&&t!=="parent")throw new Error("Only parent can delete shared sets.");if(!m||h){o(u=>{const g=u.filter(S=>S.id!==r.id);return M(T(m),g),g});return}const f=i==="shared"?["wordSets","shared","sets",r.id]:["wordSets",m,"sets",r.id];await ne(D(v,...f))},[h,t]),p=c.useCallback(async(r,m)=>{const i=r.owner||"shared";if(i==="shared"&&t!=="parent")throw new Error("Only parent can update shared sets.");if(!m||h){o(u=>{const g=u.map(S=>S.id===r.id?F({...S,...r}):S);return M(T(m),g),g});return}const f=i==="shared"?D(v,"wordSets","shared","sets",r.id):D(v,"wordSets",m,"sets",r.id);await q(f,{...F(r),updatedAt:H()},{merge:!0})},[h,t]),C=c.useCallback(async(r,m)=>{if(!Array.isArray(r)||r.length===0)return;if(!m||h){let S=0,w=0;return o(j=>{var O;const A=new Map(j.map(N=>[N.id,N]));for(let N=0;N<r.length;N+=1){const L=r[N],k=L.id||`ws_${Date.now()}_${N}_${Math.random().toString(36).slice(2,7)}`;A.has(k)?w+=1:S+=1,A.set(k,F({...L,id:k,createdAt:((O=A.get(k))==null?void 0:O.createdAt)||Date.now()}))}const $=Array.from(A.values());return M(T(m),$),$}),{total:r.length,created:S,updated:w}}const i=ae(v);let f=0,u=0;const g=new Set(s.map(S=>S.id));for(let S=0;S<r.length;S+=1){const w=r[S],j=w.owner||"shared";if(j==="shared"&&t!=="parent")throw new Error("Only parent can write shared sets.");const A=w.id||`ws_${Date.now()}_${S}_${Math.random().toString(36).slice(2,7)}`;g.has(A)?u+=1:f+=1;const $=j==="shared"?D(v,"wordSets","shared","sets",A):D(v,"wordSets",m,"sets",A);i.set($,{...F(w),id:A,createdAt:H()})}return await i.commit(),{total:r.length,created:f,updated:u}},[h,t,s]);return{wordSets:s,loading:x,isOffline:h,addWordSet:d,updateWordSet:p,deleteWordSet:l,bulkAddWordSets:C}}function ie(e){const[t,s]=c.useState(()=>y(E(e),{})),[o,x]=c.useState(()=>y(`${E(e)}_stats`,P)),[_,h]=c.useState(!1);c.useEffect(()=>{if(!e){s(y(E(e),{})),x(y(`${E(e)}_stats`,P)),h(!0);return}const d=D(v,"records",e);return K(d,p=>{if(p.exists()){const C=p.data(),{_stats:r,...m}=C;s(m),x(r||P),M(E(e),m),M(`${E(e)}_stats`,r||P),h(!1)}else s({}),x(P),M(E(e),{}),M(`${E(e)}_stats`,P),h(!1)},()=>{h(!0),s(y(E(e),{})),x(y(`${E(e)}_stats`,P))})},[e]);const b=c.useCallback(async(d,l,p)=>{if(!d)return;const C=()=>{const m=y(E(d),{}),i=m[l]||{},f=y(`${E(d)}_stats`,P),u={totalSessions:(f.totalSessions||0)+1,totalCorrect:(f.totalCorrect||0)+((p.totalCorrect||0)-(i.totalCorrect||0)),totalItems:(f.totalItems||0)+((p.totalItems||0)-(i.totalItems||0))},g={...m,[l]:p};s(g),x(u),M(E(d),g),M(`${E(d)}_stats`,u)};if(_){C();return}const r=D(v,"records",d);try{await oe(v,async m=>{const i=await m.get(r),f=i.exists()?i.data():{},u=f[l]||{},g=f._stats||P,S={totalSessions:(g.totalSessions||0)+1,totalCorrect:(g.totalCorrect||0)+((p.totalCorrect||0)-(u.totalCorrect||0)),totalItems:(g.totalItems||0)+((p.totalItems||0)-(u.totalItems||0))};m.set(r,{...f,[l]:p,_stats:S},{merge:!0})})}catch{h(!0),C()}},[_]);return{records:t,stats:o,isOffline:_,saveRecord:b}}function de(e){const[t,s]=c.useState(()=>y(W(e),!1));c.useEffect(()=>{if(!e){s(y(W(e),!1));return}const _=D(v,"users",e);return K(_,b=>{var l;const d=!!((l=b.data())!=null&&l.exportNeeded);s(d),M(W(e),d)},()=>{s(y(W(e),!1))})},[e]);const o=c.useCallback(async()=>{if(s(!0),M(W(e),!0),!!e)try{await q(D(v,"users",e),{exportNeeded:!0,updatedAt:H()},{merge:!0})}catch{}},[e]),x=c.useCallback(async()=>{if(s(!1),M(W(e),!1),!!e)try{await q(D(v,"users",e),{exportNeeded:!1,updatedAt:H()},{merge:!0})}catch{}},[e]);return{needExportAlert:t,markExportNeeded:o,clearExportNeeded:x}}const V=864e5;function me(e,t,s){if(s<.3)return{interval:1,easeFactor:Math.max(1.3,t-.2)};if(s<.6)return{interval:Math.max(1,Math.floor(e*.8)),easeFactor:Math.max(1.3,t-.1)};const o=Math.min(2.5,t+.1*(s-.6));return{interval:e===0?1:e===1?3:Math.round(e*o),easeFactor:o}}function ue(e){return!e||!e.nextDue?!0:Date.now()>=e.nextDue}function he(e){return{3:5,2:3,1:1,0:0}[e]??0}function fe(e,t,s,o=5,x={}){const{preferMemorized:_=!1}=x,b=e.filter(d=>!(s.length>0&&!s.includes(d.importance))).map(d=>{const l=t[d.id],p=ue(l),C=he(d.importance),r=l!=null&&l.nextDue?Math.max(0,Date.now()-l.nextDue)/V:999,m=!l;let i=0;if(m?i=1e3+C*10:p?i=500+C*10+r:i=C,_){const f=(l==null?void 0:l.memorizedCount)||0,u=l!=null&&l.lastMemorized?Math.max(0,Date.now()-l.lastMemorized)/V:999,g=l!=null&&l.lastMemorized?Math.max(0,30-u):0;i+=f*20+g}return{ws:d,score:i}});return b.sort((d,l)=>l.score-d.score),b.slice(0,o).map(d=>d.ws)}function ke(e,t,s,o={}){const{mode:x="timeattack"}=o,_=e||{interval:0,easeFactor:2,totalSessions:0,totalCorrect:0,totalItems:0},h=Date.now();if(x==="memorize")return{..._,lastStudied:h,lastMemorized:h,memorizedCount:(_.memorizedCount||0)+1};const b=s>0?t/s:0,{interval:d,easeFactor:l}=me(_.interval,_.easeFactor,b);return{..._,interval:d,easeFactor:l,lastStudied:h,nextDue:h+d*V,totalSessions:(_.totalSessions||0)+1,totalCorrect:(_.totalCorrect||0)+t,totalItems:(_.totalItems||0)+s,lastScore:b}}function De(e){if(!e)return"‰ªä„Åô„Åê";const t=e-Date.now();if(t<=0)return"‰ªä„Åô„Åê";const s=Math.ceil(t/V);return s===1?"ÊòéÊó•":`${s}Êó•Âæå`}const Se=["memorize",.5,.75,1,2,3,4,5],pe=[{value:"english",label:"Ëã±Ë™û"},{value:"japanese",label:"ÂõΩË™û"},{value:"math",label:"ÁÆóÊï∞"}],xe=5,Q=e=>`home_pref_${e||"guest"}`,I=(e,t)=>`memorize_cursor_${e||"guest"}_${t}`;function ge(e,t){const s=[...e];for(let o=s.length-1;o>0;o-=1){const x=Math.floor(Math.random()*(o+1)),_=s[o];s[o]=s[x],s[x]=_}return s.slice(0,t)}function _e(e,t,s){if(e.length===0)return[];const o=[];for(let x=0;x<t;x+=1)o.push(e[(s+x)%e.length]);return o}function be(e){try{const t=localStorage.getItem(Q(e));return t?JSON.parse(t):{}}catch{return{}}}function je(e,t){try{localStorage.setItem(Q(e),JSON.stringify(t))}catch{}}function we(e,t){try{const s=localStorage.getItem(I(e,t)),o=Number(s);return Number.isFinite(o)&&o>=0?o:0}catch{return 0}}function Ne(e,t,s){try{localStorage.setItem(I(e,t),String(Math.max(0,s)))}catch{}}function ve({profile:e,wordSets:t,records:s,onStartSession:o,onLogout:x,needExportAlert:_,userId:h}){const b=c.useMemo(()=>be(h),[h]),[d,l]=c.useState(b.flashTime??3),[p,C]=c.useState(b.subject??"english"),[r,m]=c.useState(b.mathAnswerMode??"none"),[i,f]=c.useState(b.importanceFilter??[3,2,1]),[u,g]=c.useState(b.levelFilter??[]),[S,w]=c.useState(b.setCount??5),[j,A]=c.useState(0),$=d==="memorize"?"memorize":"timeattack",O=c.useMemo(()=>t.filter(n=>(n.subject||"english")===p),[t,p]),N=c.useMemo(()=>Array.from(new Set(O.map(n=>n.level).filter(Boolean))),[O]);c.useEffect(()=>{g(n=>{const z=n.filter(U=>N.includes(U));return z.length>0?z:N})},[N]),c.useEffect(()=>{je(h,{flashTime:d,subject:p,mathAnswerMode:r,importanceFilter:i,levelFilter:u,setCount:S})},[h,d,p,r,i,u,S]),c.useEffect(()=>{A(we(h,p))},[h,p]);const L=c.useMemo(()=>O.filter(n=>u.includes(n.level)),[O,u]),k=c.useMemo(()=>L.filter(n=>i.includes(n.importance)),[L,i]),B=c.useMemo(()=>{const n=Math.max(1,Math.min(xe,Number(S)||5));return $==="memorize"?_e(k,n,j):p==="math"?ge(k,n):fe(L,s,i,n,{preferMemorized:!0})},[$,S,k,j,p,L,s,i]),ee=n=>{f(z=>z.includes(n)?z.filter(U=>U!==n):[...z,n])},te=n=>{g(z=>z.includes(n)?z.filter(U=>U!==n):[...z,n])},se=()=>{if($==="memorize"&&k.length>0&&B.length>0){const n=(j+B.length)%k.length;A(n),Ne(h,p,n)}o({flashTime:d,importanceFilter:i,levelFilter:u,sets:B,subject:p,sessionMode:$,mathAnswerMode:r})};return a.jsxs("div",{className:"card",children:[a.jsxs("div",{className:"row between",children:[a.jsx("h2",{children:"„Éõ„Éº„É†"}),a.jsx("button",{className:"btn btn-ghost",onClick:x,children:"„É≠„Ç∞„Ç¢„Ç¶„Éà"})]}),a.jsxs("p",{className:"muted",children:["„É¶„Éº„Ç∂„Éº: ",(e==null?void 0:e.displayName)||"Guest"," (",(e==null?void 0:e.role)||"child",")"]}),_&&a.jsx("div",{className:"offline-banner",children:"„Éá„Éº„Çø„Çª„ÉÉ„Éà„Å´Â§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Å¶PC„ÅÆExcel„ÇíÊõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"}),a.jsxs("div",{className:"section",children:[a.jsx("label",{children:"ÁßëÁõÆ"}),a.jsx("div",{className:"row",children:pe.map(n=>a.jsx("button",{className:`chip ${p===n.value?"active":""}`,onClick:()=>C(n.value),children:n.label},n.value))})]}),a.jsxs("div",{className:"section",children:[a.jsx("label",{children:"„Éï„É©„ÉÉ„Ç∑„É•ÊôÇÈñì / „É¢„Éº„Éâ"}),a.jsx("div",{className:"row",children:Se.map(n=>a.jsx("button",{className:`chip ${d===n?"active":""}`,onClick:()=>l(n),children:n==="memorize"?"ÊöóË®ò„É¢„Éº„Éâ":`${n}s`},n))})]}),p==="math"&&$==="timeattack"&&a.jsxs("div",{className:"section",children:[a.jsx("label",{children:"ÁÆóÊï∞„É¢„Éº„Éâ"}),a.jsxs("div",{className:"row",children:[a.jsx("button",{className:`chip ${r==="none"?"active":""}`,onClick:()=>m("none"),children:"Á≠î„ÅàÂêà„Çè„Åõ„Å™„Åó"}),a.jsx("button",{className:`chip ${r==="showAnswer"?"active":""}`,onClick:()=>m("showAnswer"),children:"Á≠î„ÅàÂêà„Çè„Åõ„ÅÇ„Çä"})]})]}),a.jsxs("div",{className:"section",children:[a.jsx("label",{children:"ÈáçË¶ÅÂ∫¶"}),a.jsx("div",{className:"row",children:[3,2,1,0].map(n=>a.jsx("button",{className:`chip ${i.includes(n)?"active":""}`,onClick:()=>ee(n),children:"‚òÖ".repeat(n)||"‚òÜ"},n))})]}),a.jsxs("div",{className:"section",children:[a.jsx("label",{children:"„É¨„Éô„É´"}),a.jsx("div",{className:"row",children:N.map(n=>a.jsx("button",{className:`chip ${u.includes(n)?"active":""}`,onClick:()=>te(n),children:n},n))})]}),a.jsxs("div",{className:"section",children:[a.jsx("label",{children:"Âá∫È°å„Çª„ÉÉ„ÉàÊï∞ÔºàÊúÄÂ§ß5Ôºâ"}),a.jsx("div",{className:"row",children:[1,2,3,4,5].map(n=>a.jsx("button",{className:`chip ${S===n?"active":""}`,onClick:()=>w(n),children:n},n))})]}),$==="memorize"&&a.jsx("div",{className:"muted",children:"ÊöóË®ò„É¢„Éº„Éâ„ÅØÂâçÂõû„ÅÆÁ∂ö„Åç„Åã„ÇâËá™ÂãïÈÅ∏Âá∫„Åó„Åæ„Åô„ÄÇ"}),a.jsxs("div",{className:"section",children:[a.jsxs("p",{className:"muted",children:["ÁôªÈå≤„Çª„ÉÉ„ÉàÁ∑èÊï∞: ",t.length]}),a.jsxs("p",{className:"muted",children:["ÁßëÁõÆÂÜÖ„Çª„ÉÉ„ÉàÊï∞: ",O.length]}),a.jsxs("p",{className:"muted",children:["„Éï„Ç£„É´„Çø„ÉºÂØæË±°: ",k.length]}),a.jsxs("p",{className:"muted",children:["‰ªäÂõûÂá∫È°å: ",B.length,"ÔºàÊúÄÂ§ß5Ôºâ"]}),a.jsx("button",{className:"btn btn-primary",disabled:B.length===0,onClick:se,children:"„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã"})]})]})}function ye({current:e,onChange:t}){const s=[["home","üè† Home"],["manage","‚öô Manage"],["stats","üìä Stats"]];return a.jsx("div",{className:"bottom-nav",children:s.map(([o,x])=>a.jsx("button",{className:`nav-btn ${e===o?"active":""}`,onClick:()=>t(o),children:x},o))})}const Me=c.lazy(()=>Y(()=>import("./SessionScreen-DaOYjHzj.js"),__vite__mapDeps([0,1,2,3,4,5]))),Ce=c.lazy(()=>Y(()=>import("./ManageScreen-BCSOf6BX.js"),__vite__mapDeps([6,1,2,3,4]))),Ae=c.lazy(()=>Y(()=>import("./StatsScreen-BbkiHsHC.js"),__vite__mapDeps([7,1,2,3,4])));function Ee({user:e,profile:t,logout:s}){const{wordSets:o,isOffline:x,addWordSet:_,updateWordSet:h,deleteWordSet:b,bulkAddWordSets:d}=le(e==null?void 0:e.uid,t==null?void 0:t.role),{records:l,stats:p,isOffline:C,saveRecord:r}=ie(e==null?void 0:e.uid),{needExportAlert:m,markExportNeeded:i,clearExportNeeded:f}=de(e==null?void 0:e.uid),[u,g]=c.useState("home"),[S,w]=c.useState(null),j=x||C,A=O=>{w(O),g("session")},$=O=>{g("home"),Promise.all(O.map(N=>r(e.uid,N.wordSetId,N.record))).catch(()=>{})};return a.jsxs("div",{className:"app",children:[j&&a.jsx("div",{className:"offline-banner",children:"üì¥ „Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ ‚Äî FirebaseÊú™Ë®≠ÂÆö„ÄÇ„Éá„Éº„Çø„ÅØ„Åì„ÅÆ„Éá„Éê„Ç§„Çπ„ÅÆ„Åø„ÄÇ"}),a.jsx("div",{className:"screen-container",children:a.jsxs(c.Suspense,{fallback:a.jsx("div",{className:"card muted",children:"Ë™≠„ÅøËæº„Åø‰∏≠..."}),children:[u==="home"&&a.jsx(ve,{profile:t,wordSets:o,records:l,stats:p,needExportAlert:m,onStartSession:A,onLogout:s,userId:e.uid}),u==="session"&&S&&a.jsx(Me,{config:S,wordSets:o,records:l,onComplete:$,onExit:()=>g("home")}),u==="manage"&&a.jsx(Ce,{wordSets:o,userId:e.uid,profile:t,onAdd:_,onUpdate:h,onDelete:b,onBulkAdd:d,onDataChanged:i,onDataUploaded:f}),u==="stats"&&a.jsx(Ae,{stats:p,records:l,wordSets:o,profile:t,userId:e.uid})]})}),u!=="session"&&a.jsx(ye,{current:u,onChange:g})]})}const ze=Object.freeze(Object.defineProperty({__proto__:null,default:Ee},Symbol.toStringTag,{value:"Module"}));export{ze as A,De as f,ke as u};
